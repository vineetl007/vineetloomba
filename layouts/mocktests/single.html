{{ define "main" }}
<div class="container mx-auto px-6 py-4">
<!--<div class="w-full max-w-[1800px] mx-auto px-2 py-4"> -->

  <h1 class="text-2xl mb-4 text-center font-bold">{{ .Title }}</h1>

  {{/* Collect questions from paths */}}
  {{ $mathQs := slice }}
  {{ range .Params.maths_questions }}
    {{ with site.GetPage . }}{{ $mathQs = $mathQs | append . }}{{ end }}
  {{ end }}

  {{ $phyQs := slice }}
  {{ range .Params.physics_questions }}
    {{ with site.GetPage . }}{{ $phyQs = $phyQs | append . }}{{ end }}
  {{ end }}

  {{ $chemQs := slice }}
  {{ range .Params.chemistry_questions }}
    {{ with site.GetPage . }}{{ $chemQs = $chemQs | append . }}{{ end }}
  {{ end }}

  {{/* Merge all with subject tag, in order Maths â†’ Physics â†’ Chemistry */}}
  {{ $all := slice }}
  {{ range $mathQs }} {{ $all = $all | append (dict "subject" "Maths" "page" .) }} {{ end }}
  {{ range $phyQs }}  {{ $all = $all | append (dict "subject" "Physics" "page" .) }} {{ end }}
  {{ range $chemQs }} {{ $all = $all | append (dict "subject" "Chemistry" "page" .) }} {{ end }}

  {{ if gt (len $all) 0 }}
    <div class="grid grid-cols-12 gap-4">

      <!-- Left: Question Palette -->
<!-- Left: Question Palette -->
<aside class="col-span-4 bg-gray-900 p-4 rounded-xl shadow-md hidden md:block">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg text-yellow-300">Question Palette</h2>
  </div>

  <!-- Unified wrapper (legend + palette) kept INSIDE the desktop aside -->
  <div id="question-palette-wrapper" class="pb-8">
    <!-- Legend -->
    <div class="grid grid-cols-2 gap-2 mb-3">
      <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded font-concert bg-gray-700"></span>Not Visited</div>
      <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded font-concert bg-white"></span>Visited</div>
      <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded font-concert bg-green-600"></span>Answered</div>
      <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded font-concert bg-purple-600"></span>Marked</div>
    </div>


    <!-- Section Headers for Palette -->
    <div id="question-palette" class="space-y-3">
      {{ if gt (len $mathQs) 0 }}<div class="text-yellow-400 font-concert">Maths</div>{{ end }}
         <div class="grid gap-2" id="maths-palette"
     style="grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));">
</div>

      {{ if gt (len $phyQs) 0 }}<div class="text-yellow-400 font-concert mt-2">Physics</div>{{ end }}
     <div class="grid gap-2" id="physics-palette"
     style="grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));">
</div>

      {{ if gt (len $chemQs) 0 }}<div class="text-yellow-400 font-concert mt-2">Chemistry</div>{{ end }}
     <div class="grid gap-2" id="chemistry-palette"
     style="grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));">
</div>
      
    </div>
  </div>

</aside>

<!-- Mobile palette: toggle button + drawer (leave these here) -->
<button id="palette-toggle" class="md:hidden fixed bottom-4 left-4 bg-purple-600 text-white px-3 py-2 rounded-lg shadow-lg z-50">
  Question Palette
</button>

<div id="palette-drawer" class="fixed top-0 left-0 h-full w-64 bg-gray-900 text-white transform -translate-x-full transition-transform duration-300 z-50 md:hidden">
<div class="p-4 flex items-center justify-between border-b border-gray-700">
  <span class="font-concert">Question Palette</span>
  <button id="palette-close" class="text-gray-300 hover:text-white text-sm px-2 py-1">âœ•</button>
</div>

 <div id="palette-mobile" class="p-4 overflow-y-auto pb-16" style="max-height: calc(100vh - 56px);">
  <!-- JS will copy wrapper content here when opened -->
</div>

</div>


      <!-- Right: Main Test Area -->
   <main class="col-span-12 md:col-span-8">
<div id="mocktest-header" class="flex flex-wrap items-center justify-between mb-4 gap-2">
  <div id="user-info" class="mb-2 text-center font-semibold"></div>
  <div id="timer" class="inline-block px-3 py-2 bg-red-700 text-white font-bold rounded">
    Time Left: <span id="time-value">00:00:00</span>
  </div>

  <div class="font-concert text-gray-300 flex flex-wrap gap-2">
    Sections: 
    {{ if gt (len $mathQs) 0 }}<span>Maths</span>{{ end }}
    {{ if gt (len $phyQs) 0 }}<span>Physics</span>{{ end }}
    {{ if gt (len $chemQs) 0 }}<span>Chemistry</span>{{ end }}
  </div>
</div>


        <div id="mocktest-app" class="min-h-[400px]"></div>
        <!-- Submit and Back Button -->
        <div class="flex justify-between items-center mt-6">
  <a href="/question-bank/"
     class="bg-blue-600 text-white py-2 px-6 rounded-lg font-bold">
    â¬… Exit
  </a>
  <button id="submit-test"
    class="bg-red-700 text-white py-2 px-6 rounded-lg font-bold">
    Submit Test
  </button>
        </div>

      </main>
    </div>

  
    <!-- Data for JS -->
<script type="application/json" id="mocktest-data">
{
  "durationMinutes": {{ or .Params.duration 180 }},
  "uid": {{ if .Params.uid }}"{{ .Params.uid | safeJS }}"{{ else }}""{{ end }},
  "rankPreset": {{ if .Params.rank_preset }}{{ .Params.rank_preset | jsonify | safeJS }}{{ else }}[]{{ end }},
  "questions": [
    {{- range $i, $item := $all -}}
      {{ $q := $item.page }}
      {
        "id": {{ add $i 1 }},
        "subject": "{{ $item.subject }}",
        "question": "{{ $q.Params.question | safeJS }}",
       "options": [
  {{- range $j, $opt := $q.Params.options -}}
    "{{ $opt | safeJS }}"{{ if ne (add $j 1) (len $q.Params.options) }},{{ end }}
  {{- end -}}
],
"correctIndices": {{ $q.Params.correctIndices | default (slice) | jsonify }},
"question_type": "{{ $q.Params.question_type }}",

        "solution": "{{ $q.Params.solution | safeJS }}",
        "numerical_answer": {{ if eq $q.Params.question_type "Integer Type" }}"{{ $q.Params.numerical_answer | safeJS }}"{{ else }}""{{ end }},
        "difficulty": {{ if $q.Params.difficulty }}"{{ $q.Params.difficulty | safeJS }}"{{ else }}""{{ end }},
        "tags": {{ if $q.Params.tags }}{{ $q.Params.tags | jsonify }}{{ else }}[]{{ end }},
        "video_url": {{ if $q.Params.video }}"https://www.youtube.com/embed/{{ $q.Params.video }}?start={{ $q.Params.start_time | default 0 }}&rel=0"{{ else }}""{{ end }}
      }{{ if not (eq (add $i 1) (len $all)) }},{{ end }}
    {{- end -}}
  ]
}
</script>
<!-- âœ… Debug block (safe, outside JSON) -->
<script>
{{- range $i, $item := $all -}}
  console.log("DEBUG: {{ $item.subject }} Q{{ add $i 1 }} correctIndices =", {{ $item.page.Params.correctIndices | jsonify }});
{{- end -}}
</script>

<!-- script for pallette on mobile -->
 <!-- âœ… Improved mobile palette script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("palette-toggle");
  const drawer = document.getElementById("palette-drawer");
  const mobile = document.getElementById("palette-mobile");
  const closeBtn = document.getElementById("palette-close"); // âœ… added
  const mainWrapper = document.getElementById("question-palette-wrapper") || document.getElementById("question-palette");

  if (!toggle || !drawer || !mobile || !mainWrapper) return;

  toggle.addEventListener("click", () => {
    // show/hide drawer
    drawer.classList.toggle("-translate-x-full");

    // copy legend + palette into drawer
    mobile.innerHTML = mainWrapper.innerHTML;

    // wire up mobile buttons to desktop buttons
    mobile.querySelectorAll(".palette-btn").forEach(mbtn => {
      const idx = mbtn.getAttribute("data-index");
      mbtn.addEventListener("click", (e) => {
        e.preventDefault();
        drawer.classList.add("-translate-x-full"); // close drawer
        const original = document.querySelector(`#question-palette .palette-btn[data-index="${idx}"]`);
        if (original) {
          original.click(); // trigger desktop button (has correct handler)
        }
      });
    });
  });

   // ðŸ‘‡ NEW close button handler
  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      drawer.classList.add("-translate-x-full");
    });
  }
  
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ðŸš€ Instruction Modal -->
<div id="instruction-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
  <div class="bg-gray-900 text-white p-6 rounded-lg max-w-xl w-full shadow-lg">
    <h2 class="text-2xl font-bold mb-4">Instructions for JEE Main Mock Test</h2>
    <ul class="list-disc list-inside mb-4 text-sm text-gray-300 space-y-1">
      <li>Total duration: 3 hours (180 minutes).</li>
      <li>Each subject has its own section: Physics, Chemistry, Mathematics.</li>
      <li>+4 marks for correct answer, â€“1 mark for incorrect (MCQ only).</li>
      <li>You may review and change answers before submitting.</li>
      <li>Do not refresh/close the page during the test.</li>
    </ul>

    <div class="mb-3">
      <label class="block text-sm mb-1">Name:</label>
      <input id="student-name" type="text" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="Enter your name">
    </div>
    <div class="mb-4">
      <label class="block text-sm mb-1">Email:</label>
      <input id="student-email" type="email" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="Enter your email">
    </div>

    <button id="start-test" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">
      Start Test
    </button>
  </div>
</div>

  
   <script src="/js/mocktest.js"></script>

  {{ else }}
    <p class="text-center">No questions found for this Mock Test.</p>
  {{ end }}
</div>
{{ end }}
