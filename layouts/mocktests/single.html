<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mock Test</title>
  <script>
    // ✅ Simulated data – in production Hugo/Decap will inject this JSON
    window.mocktestData = {
      title: "Full Mock Test",
      rank_preset: [
        { marks: 300, rank: "Top 100" },
        { marks: 250, rank: "Top 500" },
        { marks: 200, rank: "Top 2000" },
        { marks: 150, rank: "Top 5000" }
      ],
      physics_questions: [
        "/questions/physics/q1",
        "/questions/physics/q2"
      ],
      chemistry_questions: [
        "/questions/chemistry/q1"
      ],
      maths_questions: [
        "/questions/maths/q1",
        "/questions/maths/q2"
      ]
    };
  </script>
  <style>
    body { font-family: sans-serif; background: #f9fafb; }
    .question-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .palette { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin-top: 12px; }
    .palette button { padding: 4px 6px; border: 1px solid #ccc; border-radius: 4px; background: #eee; cursor: pointer; }
    .palette button.visited { background: #cfe3ff; }
    .palette button.answered { background: #b6f2c3; }
    .legend { display: flex; gap: 12px; margin-bottom: 8px; font-size: 14px; }
    .legend span { display: flex; align-items: center; gap: 4px; }
    .legend-box { width: 14px; height: 14px; border: 1px solid #aaa; }
    .legend-notvisited { background: #eee; }
    .legend-visited { background: #cfe3ff; }
    .legend-answered { background: #b6f2c3; }
  </style>
</head>
<body>
  <div class="container" style="max-width: 800px; margin: auto; padding: 16px;">
    <h1 style="text-align:center;">Mock Test</h1>
    <div id="mocktest-app"></div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const data = window.mocktestData;
    const app = document.getElementById("mocktest-app");
    let questions = [];
    let questionMeta = []; // {id, subject, visited, answered, selectedOption, correctIndices}
    let currentIndex = 0;

    // Mock fetch for demo (replace with real JSON fetch)
    async function fetchQuestion(path) {
      // Simulate questions
      return {
        question: `Question text from ${path}?`,
        options: ["Option A", "Option B", "Option C", "Option D"],
        correctIndices: [Math.floor(Math.random() * 4)] // random correct
      };
    }

    async function loadQuestions() {
      let index = 1;
      async function fetchAndPush(arr, subject) {
        for (const qPath of arr) {
          const qData = await fetchQuestion(qPath);
          questions.push(qData);
          questionMeta.push({
            id: index,
            subject,
            visited: false,
            answered: false,
            selectedOption: null,
            correctIndices: qData.correctIndices
          });
          index++;
        }
      }

      await fetchAndPush(data.physics_questions, "Physics");
      await fetchAndPush(data.chemistry_questions, "Chemistry");
      await fetchAndPush(data.maths_questions, "Maths");

      renderQuestion(0);
      renderPalette();
    }

    function renderPalette() {
      const palette = document.createElement("div");
      palette.className = "palette";
      palette.id = "question-palette";

      const grouped = {
        Physics: questionMeta.filter(q => q.subject === "Physics"),
        Chemistry: questionMeta.filter(q => q.subject === "Chemistry"),
        Maths: questionMeta.filter(q => q.subject === "Maths")
      };

      // legend
      const legend = document.createElement("div");
      legend.className = "legend";
      legend.innerHTML = `
        <span><div class="legend-box legend-notvisited"></div> Not Visited</span>
        <span><div class="legend-box legend-visited"></div> Visited</span>
        <span><div class="legend-box legend-answered"></div> Answered</span>
      `;

      app.querySelector("#question-palette")?.remove();
      app.querySelector("#legend")?.remove();

      legend.id = "legend";
      app.appendChild(legend);

      Object.entries(grouped).forEach(([subject, arr]) => {
        if (arr.length === 0) return;
        const header = document.createElement("div");
        header.textContent = subject;
        header.style.gridColumn = "1 / -1";
        header.style.fontWeight = "bold";
        palette.appendChild(header);

        arr.forEach(q => {
          const btn = document.createElement("button");
          btn.textContent = q.id;
          if (q.answered) btn.classList.add("answered");
          else if (q.visited) btn.classList.add("visited");

          btn.addEventListener("click", () => {
            currentIndex = q.id - 1;
            renderQuestion(currentIndex);
            renderPalette();
          });
          palette.appendChild(btn);
        });
      });

      app.appendChild(palette);
    }

    function renderQuestion(index) {
      const q = questions[index];
      const meta = questionMeta[index];
      meta.visited = true;

      const container = document.createElement("div");
      container.className = "question-card";
      container.id = "question-container";
      container.innerHTML = `
        <div><strong>Q${meta.id}</strong> (${meta.subject})</div>
        <div style="margin: 8px 0;">${q.question}</div>
        <div class="options">
          ${q.options
            .map(
              (opt, i) => `
              <div>
                <input type="radio" name="q${meta.id}" value="${i}" ${meta.selectedOption === i ? "checked" : ""}>
                <label>${opt}</label>
              </div>`
            )
            .join("")}
        </div>
        <div style="margin-top: 12px; display:flex; justify-content: space-between;">
          <button id="prev-btn">Prev</button>
          <button id="next-btn">Next</button>
          <button id="submit-btn" style="background:#dc2626;color:white;padding:4px 8px;border-radius:4px;">Submit</button>
        </div>
      `;

      app.querySelector("#question-container")?.remove();
      app.prepend(container);

      container.querySelectorAll(`input[name="q${meta.id}"]`).forEach(radio =>
        radio.addEventListener("change", e => {
          meta.selectedOption = parseInt(e.target.value);
          meta.answered = true;
          renderPalette();
        })
      );

      container.querySelector("#prev-btn").onclick = () => {
        if (currentIndex > 0) {
          currentIndex--;
          renderQuestion(currentIndex);
          renderPalette();
        }
      };
      container.querySelector("#next-btn").onclick = () => {
        if (currentIndex < questions.length - 1) {
          currentIndex++;
          renderQuestion(currentIndex);
          renderPalette();
        }
      };
      container.querySelector("#submit-btn").onclick = showAnalysis;
    }

    function showAnalysis() {
      let correct = 0, wrong = 0, attempted = 0;

      const review = document.createElement("div");
      review.className = "space-y-6";

      questions.forEach((q, i) => {
        const meta = questionMeta[i];
        const isCorrect = meta.selectedOption !== null && meta.correctIndices.includes(meta.selectedOption);
        if (meta.selectedOption !== null) attempted++;
        if (isCorrect) correct++; else if (meta.selectedOption !== null) wrong++;

        review.innerHTML += `
          <div class="question-card">
            <div><strong>Q${meta.id}</strong> (${meta.subject})</div>
            <div>${q.question}</div>
            <div>
              ${q.options.map((opt, idx) => {
                let cls = "";
                if (meta.selectedOption === idx) cls = isCorrect ? "background:#b6f2c3;" : "background:#ffc4c4;";
                if (q.correctIndices.includes(idx)) cls = "background:#b6f2c3;font-weight:bold;";
                return `<div style="padding:4px;border-radius:4px;${cls}">${opt}</div>`;
              }).join("")}
            </div>
          </div>`;
      });

      const totalMarks = correct * 4 - wrong;
      const nearest = data.rank_preset.reduce((prev, curr) =>
        Math.abs(curr.marks - totalMarks) < Math.abs(prev.marks - totalMarks) ? curr : prev
      );

      review.innerHTML = `
        <h2>Analysis</h2>
        <p>Total: ${questions.length}, Attempted: ${attempted}, Correct: ${correct}, Wrong: ${wrong}, Marks: ${totalMarks}</p>
        <p><strong>Predicted Rank:</strong> ${nearest.rank}</p>
      ` + review.innerHTML;

      app.innerHTML = "";
      app.appendChild(review);
    }

    loadQuestions();
  });
  </script>
</body>
</html>
